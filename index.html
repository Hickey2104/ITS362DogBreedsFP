<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dog Breed Classifier</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { max-width: 300px; margin: 10px 0; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Dog Breed Classifier</h1>
  <input type="file" id="imageInput" accept="image/*"><br>
  <img id="preview" />
  <br>
  <button id="classifyButton">Classify</button>
  <h2 id="result">Prediction: </h2>

  <script>
    let session;

    // Your real dataset breeds
    const dogBreeds = [
      "Golden_Retriever",
      "German_Shepherd",
      "Labrador_Retriever",
      "Bulldog",
      "Beagle",
      "Poodle",
      "Rottweiler",
      "Yorkshire_Terrier",
      "Boxer",
      "Dachshund"
    ];

    async function loadModel() {
      try {
        session = await ort.InferenceSession.create('./dog_breed_classifier (1).onnx', {
          executionProviders: ['wasm'],
        });
        console.log("Model loaded successfully.");
      } catch (e) {
        console.error("Failed to load model:", e);
      }
    }

    async function runModel() {
      const imageElement = document.getElementById('preview');
      if (!imageElement.src) {
        alert('Please select an image first.');
        return;
      }

      const tensor = await imageToTensor(imageElement);

      const feeds = {};
      feeds[session.inputNames[0]] = tensor;  // Auto detect input name

      const output = await session.run(feeds);
      const outputTensor = output[session.outputNames[0]];
      const scores = outputTensor.data;
      const predictedIndex = scores.indexOf(Math.max(...scores));

      let predictedBreed = "Unknown";
      if (predictedIndex < dogBreeds.length) {
        predictedBreed = dogBreeds[predictedIndex];
      }

      document.getElementById("result").innerText = `Prediction: ${predictedBreed}`;
      console.log(`Predicted Breed: ${predictedBreed}`);
    }

    async function imageToTensor(image) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const width = 224;
      const height = 224;
      canvas.width = width;
      canvas.height = height;

      ctx.drawImage(image, 0, 0, width, height);
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      const float32Data = new Float32Array(width * height * 3);
      for (let i = 0; i < width * height; i++) {
        // Normalize based on model training: mean/std from PyTorch transforms
        float32Data[i] = (data[i * 4] / 255.0 - 0.485) / 0.229;           // R
        float32Data[i + width * height] = (data[i * 4 + 1] / 255.0 - 0.456) / 0.224;  // G
        float32Data[i + 2 * width * height] = (data[i * 4 + 2] / 255.0 - 0.406) / 0.225; // B
      }

      return new ort.Tensor('float32', float32Data, [1, 3, height, width]);
    }

    document.getElementById('imageInput').addEventListener('change', function (event) {
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById('preview').src = e.target.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    });

    document.getElementById('classifyButton').addEventListener('click', runModel);

    loadModel();
  </script>
</body>
</html>
